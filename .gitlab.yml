variables:
  GIT_DEPTH: 1

stages:
  - build
  - deploy

build_and_push_staging:
  stage: build
  image: docker:stable
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
  script:
    - $(aws ecr get-login --no-include-email --region eu-west-1)
    - docker build --network=host --tag 123456.dkr.ecr.eu-west-1.amazonaws.com/one-b:$CI_COMMIT_SHORT_SHA .
    - docker push 123456.dkr.ecr.eu-west-1.amazonaws.com/one-b:$CI_COMMIT_SHORT_SHA
    - docker push 123456.dkr.ecr.eu-west-1.amazonaws.com/one-b:staging

deploy_staging:
  stage: deploy
  image: quay.io/sighup/kubectl-kustomize:1.18.2_3.6.1
  before_script:
    - cd kubernetes/staging
  script:
    - sed -i "s/@@ENVIRONMENT_PREFIX@@/$ENVIRONMENT_PREFIX/g" patch/ingress-host.yml
    - kustomize build > /dev/null
    - kustomize edit set imagetag 123456.dkr.ecr.eu-west-1.amazonaws.com/one-b:$CI_COMMIT_SHORT_SHA
    - kustomize build | kubectl apply -f -
